<app-dashboard-layout [pageTitle]="isEditMode ? 'Editar Plano de Dieta' : 'Criar Plano de Dieta'" [userProfile]="userProfile">
  <div class="form-card">
    <form [formGroup]="dietPlanForm" (ngSubmit)="onSubmit()">
      <div class="form-grid">
        <!-- Paciente -->
        <div class="form-group">
          <label for="patientId">Paciente *</label>
          <select id="patientId" formControlName="patientId" class="form-control" [class.is-invalid]="isFieldInvalid('patientId')">
            <option [ngValue]="null" disabled>Selecione um paciente</option>
            <option *ngFor="let patient of patients" [value]="patient.id">{{ patient.name }}</option>
          </select>
          <div class="error-message" *ngIf="isFieldInvalid('patientId')">
            Paciente é obrigatório.
          </div>
        </div>

        <!-- Data do Plano -->
        <div class="form-group">
          <label for="date">Data do Plano *</label>
          <input id="date" type="date" formControlName="date" class="form-control" [class.is-invalid]="isFieldInvalid('date')">
          <div class="error-message" *ngIf="isFieldInvalid('date')">
            Data é obrigatória.
          </div>
        </div>

        <!-- Entradas de Refeição Dinâmicas -->
        <div formArrayName="mealPlanEntries" class="full-width">
          <div *ngFor="let entry of mealPlanEntries.controls; let i = index" [formGroupName]="i" class="meal-entry-group">
            <!-- Tipo de Refeição -->
            <div class="form-group">
              <label [for]="'mealType-' + i">Tipo de Refeição *</label>
              <select [id]="'mealType-' + i" formControlName="mealType" class="form-control" [class.is-invalid]="isFieldInvalid('mealType', entry)">
                <option [ngValue]="null" disabled>Selecione o tipo</option>
                <option *ngFor="let type of mealTypes" [value]="type">{{ type }}</option>
              </select>
              <div class="error-message" *ngIf="isFieldInvalid('mealType', entry)">
                Tipo de refeição é obrigatório.
              </div>
            </div>

            <!-- Opção de Refeição -->
            <div class="form-group">
              <label [for]="'mealOptionId-' + i">Opção de Refeição *</label>
              <select [id]="'mealOptionId-' + i" formControlName="mealOptionId" class="form-control" [class.is-invalid]="isFieldInvalid('mealOptionId', entry)">
                <option [ngValue]="null" disabled>Selecione a opção</option>
                <option *ngFor="let option of mealOptions" [value]="option.id">{{ option.name }}</option>
              </select>
              <div class="error-message" *ngIf="isFieldInvalid('mealOptionId', entry)">
                Opção de refeição é obrigatória.
              </div>
            </div>

            <!-- Observações -->
            <div class="form-group full-width">
              <label [for]="'notes-' + i">Observações</label>
              <textarea [id]="'notes-' + i" formControlName="notes" class="form-control"></textarea>
            </div>

            <div class="meal-entry-actions">
              <button type="button" class="btn-remove" (click)="removeMealPlanEntry(i)">Remover Refeição</button>
            </div>
          </div>
        </div>
      </div>

      <button type="button" class="btn btn-secondary add-entry-button" (click)="addMealPlanEntry()">
        Adicionar Entrada de Refeição
      </button>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="onCancel()">Cancelar</button>
        <button type="submit" class="btn btn-primary" [disabled]="dietPlanForm.invalid">
          {{ isEditMode ? 'Salvar Alterações' : 'Criar Plano de Dieta' }}
        </button>
      </div>
    </form>
  </div>
</app-dashboard-layout>

